#!/bin/bash

# Check for the "install" command
if [ "$1" == "install" ]; then
  echo "Installing dependencies..."
  npm install --legacy-peer-deps
  if [ $? -eq 0 ]; then
    exit 0
  else
    exit 1
  fi
fi

# Check for the "test" command
if [ "$1" == "test" ]; then
  echo "Running tests..."
  # Run Jest and redirect output
  npx jest --coverage --json --outputFile=jest-results.json > /dev/null 2>&1
  
  # Check if Jest ran successfully
  if [ 1 ]; then
    # Parse the JSON results for total tests, passed tests, and coverage percentage
    totalTests=$(jq '.numTotalTests' jest-results.json)
    passedTests=$(jq '.numPassedTests' jest-results.json)
    lineCoverage=$(jq '.coverageMap.total.lines.pct' jest-results.json)

    # Output the required format
    echo "$passedTests/$totalTests test cases passed. $lineCoverage% line coverage achieved."
    exit 0
  else
    echo "Tests failed."
    exit 1
  fi
fi

# Check for URL_FILE argument
if [ "$#" -ne 1 ]; then
  echo "Usage: ./run URL_FILE"
  exit 1
fi

# Run the Node.js application with the provided URL_FILE
node dist/src/main.js "$1"
